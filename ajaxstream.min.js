(function(e,t,n){function c(){if(!C(e(o+"Legacy"))){var t={method:"post",enctype:"multipart/form-data",target:s+"IFrame"};e("body").append(P.getHtml("form",P.getInput(s+"Legacy",null,null,"hidden")+P.getInput(s+"FileLegacy",null,null,"file"),s+"LegacyForm",a,t)+P.getHtml("iframe",null,s+"IFrame",a,{name:s+"IFrame"}))}}function h(){var e=p()+v();return P.getDiv(e,s+"Main")}function p(){var e=d()+P.getDiv(P.getSpan(null,s+"L",s+"LR asicons-arrow-left")+P.getSpan(null,s+"R",s+"LR asicons-arrow-right"),s+"LRContainer");return P.getDiv(e,s+"ImagePreview",a)}function d(){return P.getDiv(P.getDiv(null,s+"ActionsOverlay")+P.getDiv(P.getSpan(null,s+"Add","asicons-plus",{title:m("Add another file")})+P.getSpan(null,s+"Change","asicons-upload",{title:m("Change file")})+P.getSpan(null,s+"Edit","asicons-pencil",{title:m("Edit")})+P.getSpan(null,s+"Crop","asicons-resize-shrink",{title:m("Resize image")})+P.getSpan(null,s+"Remove","asicons-trash",{title:m("Remove file")})+P.getSpan(null,s+"Close","asicons-cross",{title:m("Close window")})),s+"PreviewActions")}function v(){var e=P.getSpan(m("Choose file"),s+"ChooseText",s+"Btn")+P.getHtml("img",null,s+"Loading",a,{src:"files/loader.gif",title:m("Files are loading")});var t=P.getDiv(P.getInput(s+"File",null,a,"file")+P.getDiv(e,s+"ChooseFile"),s+"ChooseSection");t+=P.getDiv(m("DROP"),s+"DropZone",a);return P.getDiv(t,s+"UploadSection")}function g(e){return e.slice(-1)[0]}function y(e){if(e[0]){return e[0]}else{for(var t in e){if(e.hasOwnProperty(t)){return e[t]}}}}function b(e){return document.getElementById(e)}function w(e){return Object.prototype.toString.call(e)==="[object Object]"}function E(e){return typeof e==="boolean"}function S(e,t){return{name:"AjaxStream::"+e,level:"Cannot continue",message:t,htmlMessage:t,toString:function(){return["Error: AjaxStream::",e," - ",t].join("")}}}function x(e){if(typeof e===undefined||!e||O(e)&&e[r]===0||w(e)&&M(e)===0){return!0}return!1}function N(e){e=e.toLowerCase();switch(e){case"canvas":var n=document.createElement("canvas");return!!(n.getContext&&n.getContext("2d"));case"filereader":return Boolean(t.FileReader);case"file":return Boolean(t.File);case"filelist":return Boolean(t.FileList);case"blob":return Boolean(t.Blob);case"fileapi":return Boolean(t.Blob||t.File||t.FileList||t.FileReader);case"drag":return"draggable"in document.createElement("span");case"formdata":return typeof FormData==="function";case"xhrprogress":var r=new XMLHttpRequest;return!!(r&&"upload"in r&&"onprogress"in r.upload);case"multiupload":return"multiple"in document.createElement("input");default:throw T.exception("AjaxStream Error",['This function cannot be used to test the feature "',e,'"'].join(""))}}function C(e){return e[r]>0}function k(e){var t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push(e[n])}}return t}function L(e,t){var n=JSON.parse(e);return n?t?k(n):n:!1}function A(e){var t=e;if(O(t)){t={};for(var n=0,i=e[r];n<i;n++){if(!x(e[n])){t[n]=e[n]}}}return JSON.stringify(t)}function O(e){return Object.prototype.toString.call(e)==="[object Array]"}function M(e){var t=0;for(var n in e){if(e.hasOwnProperty(n))t++}return Number(t)}function _(e){return typeof e==="function"}function D(e){return e[i]("id")}function P(){function t(e,t){if(w(t)){for(var n in t){if(t.hasOwnProperty(n)){var r=t[n];if(E(r)){r=r?1:0}e.setAttribute(n,r)}}}return e}var e=this;this.getLink=function(t,n,r,i,s,o){if(!w(o)){o={}}if(s){o.rel="nofollow"}o.href=n;return e.getHtml("a",t,r,i,o)};this.getHtml=function(e,n,r,i,s){var o=document.createElement(e);if(n){o.innerHTML=n}if(r){o.id=r}if(i){o.className=i}return t(o,s).outerHTML};this.getInput=function(t,n,r,i,s){if(!w(s)){s={}}if(n!==null&&n!==""){s.value=n}if(t&&!s.name){s.name=t}s.type=i?i:"text";return e.getHtml("input",null,t,r,s)};this.getSpan=function(t,n,r,i){return e.getHtml("span",t,n,r,i)};this.getDiv=function(t,n,r,i){return e.getHtml("div",t,n,r,i)}}var r="length",i="prop",s="AJS",o="#AJS",u=".AJS",a="AJSHidden",f=function(){},l={accept:["*"],allowFilters:!0,fetchRequiredFiles:!1,maxFileSize:2097152,maxFiles:1,iconPreviewWidth:200,iconPreviewHeight:200,maxHeight:1024,maxWidth:1024,onfilechanging:f,onfilechanged:f,onfileselected:f,onfilesloaded:f,onfilesloading:f,oninit:f,onlegacyuploadfail:f,onlegacyuploadfinish:f,onlegacyuploadstart:f,onsingleuploadfail:f,onsingleuploadfinish:f,onsingleuploadstart:f,onuploadfail:f,onuploadfinish:f,onuploadprogress:f,onuploadstart:f,quality:1,resize:!0,showPreviewOnForm:!1,translateFunction:function(e){for(var t=1;t<arguments[r];t++){var n=new RegExp("\\{"+(t-1)+"\\}","g");e=e.replace(n,arguments[t])}return e},uploadScript:"upload.php",uploadTo:"uploads",uploadWithForm:!1,useViewport:!1,verbose:!1,viewportHeight:240,viewportWidth:240};e.fn.ajaxStream=function(i){function H(e,t,n){var r=n.width,i=n.height;if(r>i){if(r>u.s.maxWidth){i=Math.round(i*=u.s.maxWidth/r);r=u.s.maxWidth}}else{if(i>u.s.maxHeight){r=Math.round(r*=u.s.maxHeight/i);i=u.s.maxHeight}}t.resizedWidth=e.width=r;t.resizedHeight=e.height=i;var s=e.getContext("2d");s.drawImage(n,0,0,r,i);t.base64=e.toDataURL("image/jpeg",u.s.quality)}var u=this;if(u[r]>1){u.each(function(){e(this).ajaxStream(i)});return u}var f=e("body"),p=N("fileapi"),d={MAIN_MAX_HEIGHT:540,MAIN_MH_PCT:"45%"},v="parent",m="addClass",b="removeClass",w="append",E="click",S="unbind",x="change",T="attr",k="uploads",O="currentupload",M="changing";u.c=n;u[O]=null;u.currentlength=0;u[M]=!1;u.toload=0;u.loaded=0;u[k]=[];u.addingmore=!1;u.s=e.extend(l,i);if(typeof _!=="undefined"){function _(e){e===e;return u.s.translateFunction.apply(null,arguments)}}u.id=[u.c,"_",D(u)].join("");u.filedata={};u.legacyUpload=function(n){var i=n.files[0],s=u[M]===!1?u[k][r]:u[M];u.filedata={name:i.name,mimetype:i.type,size:i.size,newupload:!0,customFields:{},index:s,islegacy:!0};t["AJSLegacy"]=e.ajaxStream.streams[u.id];e(o+"Legacy").val(JSON.stringify({maxsize:u.s.maxFileSize,maxheight:u.s.maxHeight,maxwidth:u.s.maxWidth,uploaddir:u.s.uploadTo,islegacy:!0,id:u.id}));e(o+"LegacyForm").prop({action:u.s.uploadScript});e(o+"LegacyForm").submit()};u.afterLegacyUpload=function(e){if(e.moved){u.filedata.src=e.location;u.afterFileRead(u.filedata,u[M]!==!1)}else{alert(e.error)}};u.filechanged=function(t){var n=t.target.files;if(!n[r]){u[M]=!1;return}u.toload=n[r];if(p){e(o+"ChooseText")[m](a);e(o+"Loading")[b](a);if(u[M]===!1){var i=n[r];var s=i+u[k][r];if(s>u.s.maxFiles){console.warn(_("You have selected {0} files but are only permitted to upload {1}",s,u.s.maxFiles));i=u.toload=u.s.maxFiles-u[k][r]}for(var f=0;f<i;f++){u.process(n[f],f)}}else{u.process(n[0],u[M],!0)}}else{u.legacyUpload(this)}};u.process=function(n,r,i,o){var a=new FileReader;a.readAsArrayBuffer(n);a.onload=function(a){var f=new Blob([a.target.result],{type:n.type});var l=(t.URL||t.webkitURL).createObjectURL(f);var c=i?r:u.currentlength;var h={customFields:{},index:c,islegacy:!1,mimetype:n.type,name:n.name,newupload:!0,size:n.size,src:l};if(!i){u.currentlength++}if(n.type.match("image/*")){var p=new Image;p.onload=function(){var t=this;h.width=h.resizedWidth=t.width;h.height=h.resizedHeight=t.height;h.viewport={left:undefined,right:undefined,width:undefined,src:undefined};h.base64=null;e.ajaxStream.images[s+"IMG_"+u.id+c]=this;u.afterFileRead(h,i,o)};p.src=l}else{u.afterFileRead(h,i,o)}}};u.afterFileRead=function(e,t,n){if(t){u[k][e.index]=e}else{u[k][e.index]?u[k][e.index]=e:u[k].push(e)}u.attemptProgression(n)};u.attemptProgression=function(){u.loaded++;if(u.loaded===u.toload){e(o+"_"+u.id).val(A(u[k]));e(o+"UploadSection")[m](a);e(o+"ImagePreview")[b](a);u.toggleLR();var t=u[M]===!1;u[M]=!1;u.toload=u.loaded=0;u.displayUpload(null,t)}};u.toggleLR=function(){if(u[k][r]>1){e(o+"LRContainer")[b](a)}else{e(o+"LRContainer")[m](a)}};u.displayUpload=function(t,n){if(u[k][r]){if(!t){t=u.getCurr(n)}var i=t.src;var s=e(o+"Crop");if(t.mimetype.match("image/*")){s[b](a)}else{i=u.getIconPath(t.mimetype);s[m](a)}u.toggleLR();u.drawImage(t,i)}else{u.resetToUpload()}};u.drawImage=function(t,n){var i=s+"IMG_"+u.id+t.index,f=p&&t.mimetype.match("image/*"),l=e("#"+i);if(!l[r]){e(o+"LRContainer").before((f?'<canvas id="?"></canvas>':'<img id="?" />').replace(/\?/,i));l=e("#"+i)}if(f){H(l[0],t,e.ajaxStream.images[i])}else{l.attr({src:n})}if(t.resizedHeight<d["MAIN_MAX_HEIGHT"]){}e((f?"canvas":"img")+'[id^="AJSIMG_"]')[m](a);l[b](a)};u.getIconPath=function(e){switch(e){default:return""}};u.resetToUpload=function(){var t=e(o+"RContainer");e(o+"UploadSection")[b](a);e(o+"ImagePreview")[m](a);e(o+"ChooseText")[b](a);e(o+"Loading")[m](a);u[k][r]?t[b](a):t[m](a)};u.getCurr=function(e){if(e){u[O]=u[k][r]-1;return g(u[k])}else{if(u.addingmore){var t=g(u[k]);u[O]=t.index-1;return t}else{if(u[O]||u[O]===0){return u[k][u[O]]}u[O]=0;return y(u[k])}}};u.changePrev=function(e){var t=e?-1:1;var n;if(u[O]+t<0){n=g(u.uploads);u[O]=u[k][r]-1}else if(u[O]+t>u[k][r]-1){n=y(u[k]);u[O]=0}else{n=u[k][u[O]+t];u[O]+=t}u.displayUpload(n)};u.initBinding=function(){var n=p?e(o+"File"):e(o+"FileLegacy");e(o+"ChooseText")[S](E)[E](function(){var e={accept:u.s.accept};u.addingmore=!0;u[M]=!1;if(u.s.maxFiles>1){e["multiple"]=!0}n[T](e)[E]()});n[S](x)[x](u.filechanged);e(o+"")[S]("dbclick").dblclick(function(){if(t.getSelection){t.getSelection().removeAllRanges()}else if(document.selection){document.selection.empty()}});e(o+"Add")[S](E)[E](function(){if(u[k][r]+1>u.s.maxFiles){}else{n[E]();u.addingmore=!0}});e(o+"Change")[S](E)[E](function(){u[M]=u[O];u.addingmore=!1;n[E]()});e(o+"L")[S](E)[E](function(){u.changePrev(!0)});e(o+"R")[S](E)[E](function(){u.changePrev()});e(o+"Remove")[S](E)[E](function(){if(confirm(_("Are you sure you want to delete this file?"))){var t=[];for(var n=0,i=u[k][r];n<i;n++){if(u[k][n]&&n!==u[O]){t.push(u[k][n])}}e("#AJSIMG_"+u.id+u[O]).remove();u[k]=t;u.currentlength=u[k][r];e(o+"_"+u.id).val(A(u[k]));e(o+"UploadSection")[m](a);e(o+"ImagePreview")[b](a);u.toggleLR();u.displayUpload()}});e(o+"Close")[S](E)[E](function(){e(o).hide()});e("[id^=AJSUploadBtn_]")[S](E)[E](function(){var t=e(this).prop("id").replace(s+"UploadBtn_","");u=e.ajaxStream.streams[t];var i=e(o+"_"+u.id).val();u[k]=i[r]?L(i,!0):[];u[k][r]?u.displayUpload():u.resetToUpload();e(o+"").show();if(!u[k][r]){n[E]();u.addingmore=!0}})};u.draw=function(){var t=u[v]();u[m](a);if(C(e(o+"_"+u.id))){u.loadExisting()}else{t[w](P.getInput(s+"_"+u.id,null,null,"hidden"))}if(u.s.showPreviewOnForm){}else{t[w](P.getSpan(_("Upload"),s+"UploadBtn_"+u.id,s+"Btn",{"data-mandatory":!0}))}if(!C(e(o+""))){f[w](P.getDiv(h(u.s),s));if(!p){c()}}if(u.s.useViewport&&!e('script[src$="ajaxstreamviewport.js"]')[r]&&u.s.loadRequiredFiles){var n=document.createElement("script");n.type="text/javascript";n.src="ajaxstreamviewport.js";n.onload=function(){ajsvp.draw()};e("head").append(n)}u.initBinding()}();e.ajaxStream.streams[u.id]=u;n++;return u};if(typeof m!=="function"){function m(e){return e}}e.ajaxStream={author:"Luke Madhanga",images:{},license:"MIT",streams:{},setDefaults:function(t){l=e.extend(l,t)},submit:function(){},version:.02};P=new P})(jQuery,this,0)